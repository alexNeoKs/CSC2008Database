<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/png" href="../assets/img/favicon.png">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap.min.js"></script>
        <script>  

            var _DataTable1;
            var _DataTable2;
            
            async function doSomething1()
            {
                console.log("Body loaded")

                _DataTable1 = $('#dt1').DataTable({
                                                "columns": [
                                                    { "data": "name"         , "title": "Song Name"    },
                                                    { "data": "year"         , "title": "Year"         },
                                                    { "data": "disc"         , "title": "Disc Number"  },
                                                    { "data": "track"        , "title": "Track Number" },
                                                    { "data": "album"        , "title": "Album"        },
                                                    { "data": "artist"       , "title": "Artist"       }
                                                ]
                                             });

                _DataTable2 = $('#dt2').DataTable({
                                                "columns": [
                                                    { "data": "name"         , "title": "Song Name"    },
                                                    { "data": "year"         , "title": "Year"         },
                                                    { "data": "disc_number"  , "title": "Disc Number"  },
                                                    { "data": "track_number" , "title": "Track Number" },
                                                    { "data": "album"        , "title": "Album"        },
                                                    { "data": "artist"       , "title": "Artist"       }
                                                ]
                                             });
            }

            async function doSomething2()
            {
                try
                {
                    let song      = document.getElementById('songName')
                    let artist    = document.getElementById('artistName')
                    let album     = document.getElementById('albumName')
                    let tb1       = document.getElementById('tb1')
                    let tb2       = document.getElementById('tb2')
                    let elapsed1  = document.getElementById('elapsed1')
                    let elapsed2  = document.getElementById('elapsed2')

                    let hasSong   = false
                    let hasArtist = false
                    let hasAlbum  = false
                    let inputs    = {}

                    _DataTable1.clear().draw();
                    tb1.innerHTML = ""
                    tb1.innerHTML = "Please wait"

                    _DataTable2.clear().draw();
                    tb2.innerHTML = ""
                    tb2.innerHTML = "Please wait"

                    //-------------------------------------------------
                    if( song != null && song.value.length > 0 ) 
                    {
                        hasSong = true
                    }
                    if( artist != null && artist.value.length > 0 ) 
                    {
                        hasArtist = true
                    }
                    if( album != null && album.value.length > 0 ) 
                    {
                        hasAlbum = true
                    }

                    //-------------------------------------------------
                    let sqlQuery = ""
                    if( hasSong && hasArtist && hasAlbum )
                    {
                        sqlQuery = ""
                    }
                    else if( hasSong && hasArtist && !hasAlbum )
                    {
                        sqlQuery = ""
                    }
                    else if( hasSong && !hasArtist && hasAlbum )
                    {
                        inputs = {                
                                    'procName' : 'FindArtistsBySongAndAlbumName',
                                    'arg1'     :  String(album.value),
                                    'arg2'     :  String(song.value) 
                                 };
                    }
                    else if( !hasSong && hasArtist && hasAlbum )
                    {
                        sqlQuery = ""
                    }
                    else if( hasSong && !hasArtist && !hasAlbum )
                    {
                        inputs = {
                                    'procName' : 'FindArtistsAndAlbumsBySongName',
                                    'arg1'     : String(song.value)
                                 };
                    }
                    else if( !hasSong && hasArtist && !hasAlbum )
                    {
                        inputs = {
                                   'procName' : 'FindSongsAndAlbumsByArtistName',
                                   'arg1'     : String(artist.value),
                                 };
                    }
                    else if( !hasSong && !hasArtist && hasAlbum )
                    {
                        inputs = {
                                   'procName' : 'FindSongsAndArtistsByAlbumName',
                                   'arg1'     : String(album.value),
                                 };
                    }
                    else
                    {
                        sqlQuery = ""
                    }
                    //-------------------------------------------------
                    if( hasSong || hasArtist || hasAlbum )
                    {
                        const request_header = {
                                                    method  : 'POST',
                                                    headers : {
                                                                'Accept'       : 'application/json',
                                                                'Content-Type' : 'application/json',
                                                            },
                                                    body : JSON.stringify( inputs ),
                                               };
                        try
                        {
                            //----------------------------------------------------------------------------------------------------------
                            // Call SQL stored procedures
                            //----------------------------------------------------------------------------------------------------------
                            fetch( 'http://localhost:3000/sql/call' , request_header )
                                            .then(  response => response.json() )
                                            .then(  response => {
                                                                    const { results , elapsed } = response
                                                                    elapsed1.innerHTML = "Query took " + elapsed + " milliseconds"
                                                                    tb1.innerHTML = ""
                                                                    rows = ""
                                                                    collection = []
                                                                    results.map( record => {
                                                                        const doc = JSON.parse( record[0] )

                                                                        collection.push(doc)
                                                                        const { name , year , disc , track , album , artist } = doc

                                                                        const row = `<tr>
                                                                                <td>${name}</td>
                                                                                <td>${year}</td>
                                                                                <td>${disc}</td>
                                                                                <td>${track}</td>
                                                                                <td>${album}</td>
                                                                                <td>${artist}</td>
                                                                               </tr>`
                                                                        rows += row
                                                                    })
                                                                    tb1.innerHTML = rows
                                                                    _DataTable1.clear().draw();
                                                                    _DataTable1.rows.add(collection).draw();
                                                                })
                                            .catch( err      => console.log(err) )
                            //----------------------------------------------------------------------------------------------------------
                            // Call MongoDB queries
                            //----------------------------------------------------------------------------------------------------------
                            fetch( 'http://localhost:3000/nosql/call' , request_header )
                                            .then(  response => response.json() )
                                            .then(  response => { 
                                                                    const { results , elapsed } = response
                                                                    elapsed2.innerHTML = "Query took " + elapsed + " milliseconds"
                                                                    tb2.innerHTML = ""
                                                                    rows = ""
                                                                    collection = []
                                                                    
                                                                    results.map( record => {

                                                                        collection.push(record)
                                                                        const { name , year , disc_number , track_number , album , artist } = record

                                                                        const row = `<tr>
                                                                                <td>${name}</td>
                                                                                <td>${year}</td>
                                                                                <td>${disc_number}</td>
                                                                                <td>${track_number}</td>
                                                                                <td>${album}</td>
                                                                                <td>${artist}</td>
                                                                               </tr>`
                                                                        rows += row
                                                                    })
                                                                    tb2.innerHTML = rows
                                                                    _DataTable2.clear().draw();
                                                                    _DataTable2.rows.add(collection).draw();
                                                                })
                                            .catch( err      => console.log(err) )
                        }
                        catch( err )
                        {
                            console.log( err )
                        }
                    }
                    else
                    {
                        console.log("No inputs")
                    }
                    //-------------------------------------------------
                }
                catch( err )
                {
                    console.log( "Error : " , err )
                }
            }
        </script>
    </head>

    <body onLoad="doSomething1()">
        <h3>CSC2008 Database project</h3>

            <div>
                <div id='inputs'> 
                    <label for='songName'>Song Name</label> 
                    <textarea id='songName' name='songName' wrap="soft" maxlength="255"></textarea>
                    <hr>

                    <label for='artistName'>Artist Name</label> 
                    <textarea id='artistName' name='artistName' wrap="soft" maxlength="255"></textarea>
                    <hr>

                    <label for='albumName'>Album Name</label> 
                    <textarea id='albumName' name='albumName' wrap="soft" maxlength="255"></textarea>
                    <hr>
                    <Button onClick="doSomething2()">Search</Button>
                </div>
                <hr>
                <div><h3>Results From MySQL</h3></div>
                <div><center><b><span id='elapsed1'>Execution Time</span></b></center></div>
                <div class="container mt-6 mb-6">
                    <table class='table table-striped' id='dt1'>
                        <thead>
                                <th>song</th>
                                <th>year</th>
                                <th>disc</th>
                                <th>track</th>
                                <th>album</th>
                                <th>artist</th>
                        </thead>
                        <tbody  id='tb1'>
                        </tbody>
                    </table>
                </div>

                <hr>
                <h3>Results From MongoDB</h3>
                <div><center><b><span id='elapsed2'>Execution Time</span></b></center></div>
                <div class="container mt-6 mb-6">
                    <table class='table table-striped' id='dt2'>
                        <thead>
                                <th>song</th>
                                <th>year</th>
                                <th>disc</th>
                                <th>track</th>
                                <th>album</th>
                                <th>artist</th>
                        </thead>
                        <tbody  id='tb2'>
                        </tbody>
                    </table>
                </div>

            </div>

    </body>

</html>